<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SatoshiFi Mining Pool Manager</title>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <link rel="stylesheet" href="/css/pool-manager.css">
</head>
<body>
    <div class="pool-manager-container">
        <div class="container">
            <div class="header">
                <h1>SatoshiFi Mining Pool Manager</h1>
                <p>FROST-enabled Bitcoin mining pools on Ethereum Sepolia</p>
            </div>

            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="statusText">Not connected to wallet</span>
                <button class="btn" onclick="connectWallet()" id="connectBtn">Connect MetaMask</button>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="tabs">
                <button class="tab-button active" onclick="showTab('pools')">Pools</button>
                <button class="tab-button" onclick="showTab('frost')">FROST Setup</button>
                <button class="tab-button" onclick="showTab('workers')">Workers</button>
                <button class="tab-button" onclick="showTab('miners')">Miners</button>
                <button class="tab-button" onclick="showTab('rewards')">Rewards</button>
                <button class="tab-button" onclick="showTab('stats')">Statistics</button>
            </div>

            <!-- POOLS TAB -->
            <div id="pools-tab" class="tab-content active">
                <div class="grid">
                    <div class="card">
                        <h3>Create New Pool</h3>
                        <div class="form-group">
                            <label for="pool-id">Pool ID</label>
                            <input type="text" id="pool-id" placeholder="satoshifi-btc-001">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mp-name">MP Token Name</label>
                                <input type="text" id="mp-name" placeholder="SatoshiFi BTC Pool">
                            </div>
                            <div class="form-group">
                                <label for="mp-symbol">MP Token Symbol</label>
                                <input type="text" id="mp-symbol" placeholder="mpBTC-001">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pubkey-x">Group Pubkey X (from FROST DKG)</label>
                                <input type="text" id="pubkey-x" placeholder="0x1a2b3c4d..." readonly>
                                <small>Generated via FROST DKG session</small>
                            </div>
                            <div class="form-group">
                                <label for="pubkey-y">Group Pubkey Y (from FROST DKG)</label>
                                <input type="text" id="pubkey-y" placeholder="0x5e6f7890..." readonly>
                                <small>Generated via FROST DKG session</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="payout-script">Bitcoin Payout Script (hex)</label>
                            <input type="text" id="payout-script" placeholder="0x5120..." readonly>
                            <small>Auto-generated Taproot P2TR script</small>
                        </div>
                        <div class="form-group">
                            <label for="calculator">Reward Calculator</label>
                            <select id="calculator">
                                <option value="0">PPLNS (Pay Per Last N Shares)</option>
                                <option value="1">PPS (Pay Per Share)</option>
                                <option value="2">FPPS (Full Pay Per Share)</option>
                                <option value="3">Score (Score Based)</option>
                            </select>
                        </div>
                        <button class="btn" onclick="createPool()">Create Pool</button>
                    </div>

                    <div class="card">
                        <h3>Existing Pools</h3>
                        <button class="btn btn-secondary" onclick="refreshPoolsList()">Refresh</button>
                        <div id="pools-list">
                            <p style="text-align: center; opacity: 0.7;">No pools loaded. Click Refresh to load pools.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FROST SETUP TAB -->
            <div id="frost-tab" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Generate Group Pubkey (DKG)</h3>
                        <div class="form-group">
                            <label for="custodians">Custodian Addresses (one per line)</label>
                            <textarea id="custodians" placeholder="0x1234...&#10;0x5678...&#10;0x9abc..." rows="4"></textarea>
                            <small>Enter Ethereum addresses of FROST participants. For solo mining, use only your address with threshold = 1</small>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="threshold">Threshold (signatures required)</label>
                                <input type="number" id="threshold" placeholder="2" min="1" value="1">
                                <small>Number of signatures required to spend funds (1 for solo)</small>
                            </div>
                            <div class="form-group">
                                <label for="deadline">Deadline (hours from now)</label>
                                <input type="number" id="deadline" placeholder="24" min="1" value="24">
                                <small>Time limit for DKG completion</small>
                            </div>
                        </div>
                        <button class="btn" onclick="startDKG()">Start DKG Session</button>
                        <button class="btn btn-secondary" onclick="finalizeDKG()">Finalize DKG</button>
                    </div>

                    <div class="card">
                        <h3>FROST Sessions</h3>
                        <button class="btn btn-secondary" onclick="refreshFROSTSessions()">Refresh</button>
                        <div id="frost-sessions">
                            <p style="text-align: center; opacity: 0.7;">Click Refresh to load FROST sessions.</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Generated Group Keys</h3>
                    <div id="group-keys">
                        <p style="text-align: center; opacity: 0.7;">No group keys generated yet.</p>
                    </div>
                </div>
            </div>

            <!-- WORKERS TAB -->
            <div id="workers-tab" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Add Worker</h3>
                        <div class="form-group">
                            <label for="selected-pool">Select Pool</label>
                            <select id="selected-pool">
                                <option value="">Select a pool...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="worker-id">Worker ID</label>
                            <input type="text" id="worker-id" placeholder="worker_1">
                        </div>
                        <div class="form-group">
                            <label for="hashrate">Hash Rate (TH/s)</label>
                            <input type="number" id="hashrate" placeholder="100" min="1">
                        </div>
                        <button class="btn" onclick="registerWorker()">Register Worker</button>
                    </div>

                    <div class="card">
                        <h3>Active Workers</h3>
                        <button class="btn btn-secondary" onclick="refreshWorkersList()">Refresh</button>
                        <div id="workers-list">
                            <p style="text-align: center; opacity: 0.7;">No workers loaded.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MINERS TAB -->
            <div id="miners-tab" class="tab-content">
                <div class="card">
                    <h3>Pool Miners</h3>
                    <div id="current-miner-info" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>You are registered as miner</strong></p>
                        <p>Address: <span id="miner-address">Not connected</span></p>
                        <p>Workers: <span id="miner-worker-count">0</span></p>
                    </div>

                    <h4>Unassigned Workers</h4>
                    <div id="unassigned-workers">
                        <p style="text-align: center; opacity: 0.7;">Loading unassigned workers...</p>
                    </div>

                    <button class="btn" onclick="claimSelectedWorkers()">Claim Selected Workers</button>
                </div>
            </div>

            <!-- REWARDS TAB -->
            <div id="rewards-tab" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h3>Distribute Rewards</h3>
                        <div class="form-group">
                            <label for="reward-pool">Pool</label>
                            <select id="reward-pool">
                                <option value="">Select pool...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reward-amount">Amount (BTC)</label>
                                <input type="number" id="reward-amount" placeholder="1.0" step="0.00000001">
                            </div>
                            <div class="form-group">
                                <label for="period-id">Period ID</label>
                                <input type="number" id="period-id" placeholder="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="block-height">Bitcoin Block Height</label>
                            <input type="number" id="block-height" placeholder="100">
                        </div>
                        <button class="btn" onclick="distributeRewards()">Distribute Rewards</button>
                    </div>

                    <div class="card">
                        <h3>Rewards History</h3>
                        <button class="btn btn-secondary" onclick="refreshRewardsHistory()">Refresh</button>
                        <div id="rewards-history">
                            <p style="text-align: center; opacity: 0.7;">No rewards history loaded.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATISTICS TAB -->
            <div id="stats-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="total-shares">-</span>
                        <div class="stat-label">Total Shares (24h)</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="valid-shares">-</span>
                        <div class="stat-label">Valid Shares (24h)</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="total-blocks">-</span>
                        <div class="stat-label">Total Blocks</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="active-workers">-</span>
                        <div class="stat-label">Active Workers</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Mining Statistics</h3>

                    <!-- Кнопки статистики -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="refreshMiningStats()">Refresh Stats</button>
                        <button class="btn btn-secondary" onclick="testAPI()">Test API</button>
                    </div>

                    <!-- Кнопки управления майнингом -->
                    <div class="mining-controls">
                        <h4>Mining Controls</h4>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="startMining()">Start Mining</button>
                            <button class="btn btn-danger" onclick="stopMining()">Stop Mining</button>
                            <button class="btn btn-success" onclick="startShares()">Start Shares</button>
                            <button class="btn btn-danger" onclick="stopShares()">Stop Shares</button>
                        </div>
                    </div>

                    <!-- Статистика -->
                    <div id="mining-stats">
                        <p style="text-align: center; opacity: 0.7;">Click Refresh to load statistics.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/lib/ethers-5.7.2.umd.min.js"></script>
    <script src="/js/lib/bitcoin-simple.min.js"></script>

    <!-- App modules -->
    <script src="/js/config.js"></script>
    <script src="/js/web3-integrator.js"></script>
    <script src="/js/pool-manager.js"></script>
    <script src="/js/worker-manager.js"></script>
    <script src="/js/ui-controller.js"></script>
    <script src="/js/frost-sessions.js"></script>
    <script src="/js/rewards-manager.js"></script>

    <!-- Main app initialization -->
    <script src="/js/mining-app.js"></script>
</body>
</html>
